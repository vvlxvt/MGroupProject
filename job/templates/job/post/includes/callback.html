{% load static %}
<br>
<div class="container my-5" id="contacts">
    <div class="row px-md-5">
        <div class="col-lg-6 px-md-5">
            <form id="contactForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden"
                       name="telegram_id"
                       value="{{ request.session.user.id }}">
                <!-- Ник в Telegram -->
                <div class="mb-1 d-flex justify-content-between align-items-center gap-1">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-at"></i></span>
                        <label for="username" class="visually-hidden">Ваш telegram login</label>
                        <input type="text"
                               name="username"
                               class="form-control"
                               placeholder="telegram login"
                               value="{{ request.session.user.username|default:'' }}"
                               readonly>
                    </div>
                    <div style="max-height:38px; margin-bottom: 2px;">
                        <script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="mgrup24_bot" data-size="large" data-radius="7" data-auth-url="https://86f5-94-43-154-7.ngrok-free.app/callback" data-request-access="write">
                        </script>
                    </div>
                </div>
                <!-- Имя -->
                <div class="mb-1">
                    <div class="input-group w-100">
                        <span class="input-group-text"><i class="fa-solid fa-user-tie"></i></span>
                        <label for="first_name" class="visually-hidden">Ваше имя</label>
                        <input type="text"
                               name="first_name"
                               class="form-control"
                               placeholder="Ваше имя"
                               value="{{ request.session.user.first_name|default:'' }}"
                               readonly>
                    </div>
                </div>
                <!-- Дата аутентификации -->
                <div class="mb-1">
                    <div class="input-group w-100">
                        <span class="input-group-text"><i class="fa-solid fa-calendar"></i></span>
                        <label for="auth_date" class="visually-hidden">Дата аутенфикации</label>
                        <input type="text"
                               name="auth_date"
                               class="form-control"
                               placeholder="Дата аутенфикации"
                               value="{{ request.session.user.auth_date|default:'' }}"
                               readonly>
                    </div>
                </div>
                <!-- Email -->
                <div class="mb-1">
                    <div class="input-group w-100 has-validation">
                        <span class="input-group-text"><i class="fa-regular fa-envelope"></i></span>
                        <label for="mail" class="visually-hidden">Ваша почта</label>
                        <input type="email"
                               class="form-control"
                               id="mail"
                               name="email"
                               value="{{ user_form.initial.email|default_if_none:'' }}"
                               placeholder="Ваш Email">
                    </div>
                    <div class="invalid-feedback d-none" id="email-error"></div>
                </div>
                <!-- Город -->
                <div class="mb-1">
                    <div class="input-group w-100 has-validation">
                        <span class="input-group-text"><i class="fa-solid fa-location-dot"></i></span>
                        <label for="city" class="visually-hidden">Ваш город</label>
                        <input type="text"
                               class="form-control"
                               id="city"
                               value="{{ user_form.initial.city|default_if_none:'' }}"
                               name="city"
                               placeholder="Укажите откуда Вы">
                    </div>
                    <div class="invalid-feedback d-none" id="city-error"></div>
                </div>
                <!-- Сообщение -->
                <div class="mb-1">
                    <label for="message" class="visually-hidden">Ваш вопрос</label>
                    <textarea class="form-control w-100"
                              id="message"
                              name="question_text"
                              placeholder="Задайте Ваш вопрос к нам"
                              required></textarea>
                    <div class="invalid-feedback d-none" id="question_text-error"></div>
                </div>
                <!-- Фото -->
                <div class="mb-3">
                    <label for="attached_photo" class="form-label">Загрузить фото</label>
                    <input type="file"
                           name="attached_photo"
                           class="form-control w-100"
                           id="attached_photo">
                    <div class="invalid-feedback d-none" id="attached_photo-error"></div>
                </div>
                <!-- Кнопка -->
                <div class="mb-3 text-center">
                    <button type="submit" class="btn button transparent">Отправить сообщение</button>
                </div>
            </form>
        </div>
        <!-- Второй столбец: Информация -->
        <div class="col-lg-6 px-md-5 mx-auto">
            <!-- текст о компании -->
            <div class="fs-5">
                <p class="text-indent">
                    К настоящему моменту вы узнали многое о "МалярГрупп". Однако остается один важный вопрос: Что конкретно
                    Маляр Групп может сделать для вашего проекта по покраске и нанесению покрытий? Сейчас у вас есть возможность узнать об этом.
                </p>
                <p class="text-indent">
                    Расскажите нам о своем проекте, о том, что вам нужно и чего вы ожидаете от подрядчика по покраске и покрытиям. Мы с удовольствием обсудим детали работы и предоставим вам дополнительную информацию о наших преимуществах, таких как:
                </p>
                <ul>
                    <li>Более двадцати лет опыта в лакокрасочной отрасли</li>
                    <li>Постоянное внимание к вопросам безопасности, которое укрепляется каждый день</li>
                    <li>Профессиональные и сертифицированные сотрудники, прекрасно знающие свое дело</li>
                    <li>Современные инструменты и оборудование, обеспечивающие высокую производительность и эффективность</li>
                    <li>Высокий уровень сервиса, который заслужил признание по всему Сибирскому региону</li>
                    <li>
                        Мы часто говорим о гордости за нашу работу в "МалярГрупп", но больше всего это чувство передается нашим клиентам, когда мы завершаем их проект по покраске и покрытиям.
                    </li>
                </ul>
                <p class="text-indent">После сотрудничества с нами мы уверены, что и вы ощутите это.</p>
            </div>
        </div>
    </div>
    <div id="formResponse" style="display:none;"></div>
</div>
<script>
document.getElementById('contactForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const form = document.getElementById('contactForm');
    const formData = new FormData(form);
    const formResponse = document.getElementById('formResponse');

    clearErrors();

    fetch("{% url 'job:submit_question' %}", {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            formResponse.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            formResponse.style.display = 'block';
            location.reload();

            setTimeout(() => formResponse.style.display = 'none', 3000);
        } else if (data.error) {
            displayErrors(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        formResponse.innerHTML = `<div class="alert alert-danger">Ошибка отправки формы. Попробуйте снова.</div>`;
        formResponse.style.display = 'block';
    });

    function clearErrors() {
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => {
            el.classList.add('d-none');
            el.innerHTML = '';
        });
    }

    function displayErrors(errors) {
        for (let field in errors) {
            const input = document.querySelector(`[name=${field}]`);
            const errorDiv = document.getElementById(`${field}-error`);
            if (input) input.classList.add('is-invalid');
            if (errorDiv && errors[field].length > 0) {
                errorDiv.classList.remove('d-none');
                errorDiv.innerHTML = errors[field][0].message;
            }
        }
    }
});
</script>
